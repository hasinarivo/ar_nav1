<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AR Restaurant Navigator</title>
    <style>
        body { 
            margin: 0; 
            padding: 0; 
            overflow: hidden;
            font-family: Arial, sans-serif;
            touch-action: none;
        }
        
        #ar-container {
            position: absolute;
            width: 100%;
            height: 100%;
            z-index: 1;
        }
        
        #ui-overlay {
            position: absolute;
            width: 100%;
            height: 100%;
            z-index: 2;
            pointer-events: none;
        }
        
        #restaurant-list {
            position: absolute;
            bottom: 20px;
            left: 10px;
            right: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            border-radius: 15px;
            padding: 15px;
            max-height: 30vh;
            overflow-y: auto;
            pointer-events: auto;
        }
        
        .restaurant-item {
            padding: 10px;
            border-bottom: 1px solid #444;
            cursor: pointer;
        }
        
        .restaurant-item:last-child {
            border-bottom: none;
        }
        
        .restaurant-item.active {
            background: rgba(255,255,255,0.2);
        }
        
        #ar-pointer {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 40px;
            color: red;
            text-shadow: 0 0 10px black;
            z-index: 3;
        }
        
        #status-bar {
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            border-radius: 10px;
            padding: 10px;
            z-index: 3;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div id="ar-container"></div>
    <div id="ui-overlay">
        <div id="ar-pointer">↑</div>
        <div id="status-bar">
            <div id="gps-status">GPS: En attente...</div>
            <div id="compass-status">Boussole: En attente...</div>
            <div id="target-info">Aucun restaurant sélectionné</div>
        </div>
        <div id="restaurant-list">
            <h3 style="margin-top:0;text-align:center;">Restaurants proches</h3>
            <div id="restaurants-container"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
    <script>
        // Variables globales
        let scene, camera, renderer;
        let userPosition = null;
        let userHeading = null;
        let targetRestaurant = null;
        let restaurants = [];
        let arrowHelper = null;
        
        // Initialisation
        init();
        
        function init() {
            setupThreeJS();
            setupUI();
            requestPermissions();
            simulateRestaurants();
        }
        
        function setupThreeJS() {
            // Scene
            scene = new THREE.Scene();
            
            // Camera (mobile AR orientation)
            camera = new THREE.PerspectiveCamera(
                60, 
                window.innerWidth / window.innerHeight, 
                0.1, 
                1000
            );
            camera.position.set(0, 1.6, 0); // Hauteur yeux
            
            // Renderer
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.domElement.id = 'ar-view';
            document.getElementById('ar-container').appendChild(renderer.domElement);
            
            // Lumière
            const light = new THREE.AmbientLight(0xffffff, 0.5);
            scene.add(light);
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(0, 1, 0);
            scene.add(directionalLight);
            
            // Flèche de direction
            const dir = new THREE.Vector3(0, 0, 1);
            arrowHelper = new THREE.ArrowHelper(
                dir,
                new THREE.Vector3(0, 0, 0),
                5,
                0xff0000,
                0.5,
                0.2
            );
            scene.add(arrowHelper);
            
            // Animation
            animate();
        }
        
        function setupUI() {
            // Gestion du clic sur les restaurants
            document.querySelectorAll('.restaurant-item').forEach(item => {
                item.addEventListener('click', selectRestaurant);
            });
            
            // Redimensionnement
            window.addEventListener('resize', onWindowResize);
            window.addEventListener('orientationchange', onWindowResize);
        }
        
        function requestPermissions() {
            // GPS
            if (navigator.geolocation) {
                navigator.geolocation.watchPosition(
                    position => {
                        userPosition = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude,
                            accuracy: position.coords.accuracy
                        };
                        document.getElementById('gps-status').textContent = 
                            `GPS: ${userPosition.lat.toFixed(6)}, ${userPosition.lng.toFixed(6)}`;
                        updateARPointer();
                    },
                    error => {
                        document.getElementById('gps-status').textContent = 
                            `GPS Erreur: ${error.message}`;
                        // Simulation pour le développement
                        userPosition = {
                            lat: 48.8566,
                            lng: 2.3522,
                            accuracy: 10
                        };
                    },
                    { 
                        enableHighAccuracy: true,
                        maximumAge: 3000,
                        timeout: 5000 
                    }
                );
            }
            
            // Boussole
            if (window.DeviceOrientationEvent) {
                window.addEventListener('deviceorientation', handleOrientation);
            } else {
                document.getElementById('compass-status').textContent = 
                    "Boussole: Non supportée";
                // Simulation pour le développement
                setInterval(() => {
                    userHeading = (userHeading || 0) + 1 % 360;
                    updateARPointer();
                }, 100);
            }
        }
        
        function handleOrientation(event) {
            if (event.alpha !== null) {
                userHeading = event.alpha; // 0-360
                document.getElementById('compass-status').textContent = 
                    `Boussole: ${userHeading.toFixed(1)}°`;
                updateARPointer();
            }
        }
        
        function simulateRestaurants() {
            // En production, utiliser une API comme Google Places
            restaurants = [];
            
            if (!userPosition) {
                userPosition = { lat: 48.8566, lng: 2.3522 }; // Paris par défaut
            }
            
            // Générer 10 restaurants aléatoires
            for (let i = 0; i < 10; i++) {
                const distance = 50 + Math.random() * 450; // 50-500m
                const angle = Math.random() * Math.PI * 2;
                
                const latOffset = (distance / 111320) * Math.cos(angle);
                const lngOffset = (distance / (111320 * Math.cos(userPosition.lat * Math.PI/180))) * Math.sin(angle);
                
                restaurants.push({
                    id: i,
                    name: `Restaurant ${i+1}`,
                    type: ["Français", "Italien", "Asiatique", "Fast-Food"][Math.floor(Math.random()*4)],
                    rating: (3 + Math.random()*2).toFixed(1),
                    distance: distance.toFixed(0),
                    lat: userPosition.lat + latOffset,
                    lng: userPosition.lng + lngOffset
                });
            }
            
            updateRestaurantList();
        }
        
        function updateRestaurantList() {
            const container = document.getElementById('restaurants-container');
            container.innerHTML = '';
            
            restaurants.forEach(restaurant => {
                const item = document.createElement('div');
                item.className = 'restaurant-item';
                item.dataset.id = restaurant.id;
                item.innerHTML = `
                    <strong>${restaurant.name}</strong><br>
                    ${restaurant.type} • ${restaurant.rating}★ • ${restaurant.distance}m
                `;
                item.addEventListener('click', () => selectRestaurant(restaurant.id));
                container.appendChild(item);
            });
        }
        
        function selectRestaurant(restaurantId) {
            targetRestaurant = restaurants.find(r => r.id == restaurantId);
            
            // Mettre à jour l'UI
            document.querySelectorAll('.restaurant-item').forEach(item => {
                item.classList.toggle('active', item.dataset.id == restaurantId);
            });
            
            document.getElementById('target-info').textContent = 
                `Cible: ${targetRestaurant.name} (${targetRestaurant.distance}m)`;
            
            updateARPointer();
        }
        
        function updateARPointer() {
            if (!userPosition || !userHeading || !targetRestaurant) return;
            
            // Calculer la direction vers le restaurant
            const latDiff = targetRestaurant.lat - userPosition.lat;
            const lngDiff = targetRestaurant.lng - userPosition.lng;
            
            // Conversion en mètres (approximation)
            const x = lngDiff * (111320 * Math.cos(userPosition.lat * Math.PI/180));
            const z = -latDiff * 111320; // Négatif car en Three.js, z+ = devant
            
            // Calculer l'angle
            const targetAngle = Math.atan2(x, z) * (180/Math.PI); // -180 à 180
            
            // Ajuster selon l'orientation du téléphone
            const relativeAngle = (targetAngle - userHeading + 360) % 360;
            
            // Mettre à jour la flèche 3D
            const radAngle = relativeAngle * Math.PI/180;
            const dir = new THREE.Vector3(
                Math.sin(radAngle),
                0,
                Math.cos(radAngle)
            );
            
            arrowHelper.setDirection(dir.normalize());
            arrowHelper.setLength(Math.min(5, 1000/parseInt(targetRestaurant.distance)));
            
            // Mettre à jour la flèche 2D (fallback)
            document.getElementById('ar-pointer').style.transform = 
                `translate(-50%, -50%) rotate(${-relativeAngle}deg)`;
        }
        
        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }
        
        function animate() {
            requestAnimationFrame(animate);
            renderer.render(scene, camera);
        }
    </script>
</body>
</html>