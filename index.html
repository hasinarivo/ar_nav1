<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AR¬†Restaurant¬†Navigator ‚Äì¬†Fl√®che¬†3D</title>

    <!-- Leaflet -->
    <link rel="stylesheet"
          href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

    <style>
        /* ========== G√âN√âRAL ========== */
        * { box-sizing: border-box; }
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            overflow: hidden;
        }

        /* ========== CARTE ========== */
        #map-container,
        #map {
            position: absolute;
            width: 100%;
            height: 100%;
        }

        /* ========== VUE AR ========== */
        #ar-view {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            display: none;
            z-index: 10;
        }
        #camera-feed {
            position: absolute;
            width: 100%; height: 100%;
            object-fit: cover;
        }
        #ar-overlay { /* r√©utilisable pour d‚Äôautres √©l√©ments */ }

        /* Fl√®che 3D¬†: conteneur canvas */
        #three-container {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;   /* laisse passer les touch/clic */
            z-index: 12;
        }

        /* Infos AR */
        #ar-info {
            position: absolute;
            top: 20px; left: 20px; right: 20px;
            padding: 10px;
            background: rgba(0,0,0,0.7);
            color: #fff;
            border-radius: 10px;
            display: none;
            z-index: 13;
        }

        /* ========== CONTR√îLES ========== */
        #controls {
            position: absolute;
            bottom: 20px;
            left: 50%; transform: translateX(-50%);
            display: flex; gap: 10px;
            z-index: 1000;
        }
        button {
            padding: 10px 15px;
            border: none; border-radius: 20px;
            background: #4285F4; color: #fff;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        /* ========== LISTE RESTAURANTS ========== */
        #restaurant-list {
            position: absolute;
            bottom: 80px; left: 10px; right: 10px;
            max-height: 30vh; overflow-y: auto;
            padding: 10px;
            background: rgba(255,255,255,0.95);
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            z-index: 1000;
        }
        .restaurant-item {
            padding: 10px; cursor: pointer;
            border-bottom: 1px solid #eee;
        }
        .restaurant-item:last-child { border-bottom: none; }
    </style>
</head>
<body>

<!-- ==================== CARTE ==================== -->
<div id="map-container"><div id="map"></div></div>

<!-- ==================== VUE AR ==================== -->
<div id="ar-view">
    <video id="camera-feed" autoplay playsinline></video>
    <div id="ar-overlay"></div>
    <div id="three-container"></div>
    <div id="ar-info">
        <div>Restaurant¬†: <span id="ar-restaurant-name">-</span></div>
        <div>Distance¬†: <span id="ar-distance">-</span>¬†m</div>
        <div>Direction¬†: <span id="ar-direction">-</span>¬∞</div>
    </div>
</div>

<!-- ==================== CONTR√îLES ==================== -->
<div id="controls">
    <button id="locate-btn">üìç¬†Ma position</button>
    <button id="ar-btn">üé•¬†Mode¬†AR</button>
</div>

<!-- ==================== LISTE RESTAURANTS ==================== -->
<div id="restaurant-list">
    <h3 style="margin-top:0;text-align:center;">Restaurants √† proximit√©</h3>
    <div id="restaurants-container"></div>
</div>

<!-- ==================== LIBRAIRIES ==================== -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/three@0.161.0/build/three.min.js"></script>

<!-- ==================== SCRIPT PRINCIPAL ==================== -->
<script>
/* ---------- Donn√©es ---------- */
const initialPosition = [-18.915107, 47.552972];   // point de d√©part
let userPosition = initialPosition;
let userHeading  = null;
let selectedRestaurant = null;
let cameraStream = null;

/* ---------- Leaflet ---------- */
const map = L.map('map', { zoomControl:false, attributionControl:false })
            .setView(initialPosition, 17);

const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
    { maxZoom:19, noWrap:true, detectRetina:true }).addTo(map);

function fixMapTiles() {
    setTimeout(()=>{ map.invalidateSize(); osmLayer._update(); }, 100);
}

const userMarker = L.marker(userPosition,{
    icon: L.divIcon({
        className:'user-icon',
        html:'<div style="background:#4285F4;width:24px;height:24px;border-radius:50%;border:3px solid #fff;"></div>',
        iconSize:[30,30]
    })
}).addTo(map).bindPopup("Votre position");

const restaurants = [
    { id:1, name:"Le Louvre Antananarivo", type:"Fran√ßais", rating:4.5, distance:150, position:[-18.9145,47.5532] },
    { id:2, name:"Sakura Sushi",         type:"Japonais", rating:4.2, distance:250, position:[-18.9163,47.5518] },
    { id:3, name:"La Varangue",           type:"Gastronomique", rating:4.7, distance:400, position:[-18.9138,47.5545] }
];
restaurants.forEach(r=>{
    r.marker = L.marker(r.position,{
        icon:L.divIcon({
            className:'restaurant-icon',
            html:'<div style="background:#EA4335;width:20px;height:20px;border-radius:50%;border:2px solid #fff;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:bold;">R</div>',
            iconSize:[24,24]
        })
    }).addTo(map).bindPopup(`<b>${r.name}</b><br><small>${r.type}</small><br>${'‚òÖ'.repeat(Math.round(r.rating))}¬†${r.rating.toFixed(1)}`);
});

/* ---------- UI¬†: liste restaus ---------- */
function updateRestaurantList() {
    const c = document.getElementById('restaurants-container');
    c.innerHTML = '';
    restaurants.sort((a,b)=>a.distance-b.distance).forEach(r=>{
        const div = document.createElement('div');
        div.className = 'restaurant-item';
        div.innerHTML = `<strong>${r.name}</strong><br><small>${r.type} ‚Ä¢ ${r.distance}¬†m</small>`;
        div.addEventListener('click', ()=>selectRestaurant(r));
        c.appendChild(div);
    });
}

/* ---------- S√©lection ---------- */
function selectRestaurant(r) {
    selectedRestaurant = r;
    document.getElementById('ar-restaurant-name').textContent = r.name;
    document.getElementById('ar-distance').textContent = r.distance;
    map.setView(userPosition, 17);
    map.fitBounds([userPosition, r.position], { padding:[50,50] });
    updateARPointer();
}

/* ---------- Cam√©ra ---------- */
async function startCamera() {
    try {
        if (cameraStream) cameraStream.getTracks().forEach(t=>t.stop());
        cameraStream = await navigator.mediaDevices.getUserMedia({
            video:{ facingMode:'environment', width:{ideal:1920}, height:{ideal:1080} }, audio:false
        });
        document.getElementById('camera-feed').srcObject = cameraStream;
        return true;
    } catch(e) {
        alert("Impossible d'acc√©der √† la cam√©ra¬†: "+e.message);
        console.error(e);
        return false;
    }
}

/* ---------- Calculs g√©o ---------- */
function calculateBearing(start,end){
    const [lat1,lng1]=start.map(d=>d*Math.PI/180);
    const [lat2,lng2]=end  .map(d=>d*Math.PI/180);
    const y = Math.sin(lng2-lng1)*Math.cos(lat2);
    const x = Math.cos(lat1)*Math.sin(lat2) -
              Math.sin(lat1)*Math.cos(lat2)*Math.cos(lng2-lng1);
    return (Math.atan2(y,x)*180/Math.PI+360)%360;
}

/* ---------- G√©olocalisation ---------- */
function locateUser() {
    if (!navigator.geolocation) { alert("G√©olocalisation non support√©e"); return; }
    navigator.geolocation.getCurrentPosition(
        pos=>{
            userPosition = [pos.coords.latitude, pos.coords.longitude];
            userMarker.setLatLng(userPosition);
            map.setView(userPosition,17); fixMapTiles();
            updateARPointer();
        },
        err=>{
            console.error(err);
            userPosition = initialPosition;
            userMarker.setLatLng(userPosition);
            map.setView(userPosition,17); fixMapTiles();
        },
        {enableHighAccuracy:true, maximumAge:30000, timeout:27000}
    );
}

/* ---------- Orientation ---------- */
function setupOrientation() {
    if (!window.DeviceOrientationEvent) { alert("Capteur d'orientation indisponible"); return; }
    const handler = e=>{
        if (e.alpha===null) return;
        userHeading = e.alpha;    // 0‚Äë360 (Nord = 0)
        updateARPointer();
    };
    if (typeof DeviceOrientationEvent.requestPermission === 'function') {
        DeviceOrientationEvent.requestPermission()
            .then(res=>{ if(res==='granted') window.addEventListener('deviceorientation',handler); })
            .catch(console.error);
    } else {
        window.addEventListener('deviceorientation',handler);
    }
}

/* ============================================================
   THREE.JS ‚Äì fl√®che 3D
============================================================ */
let threeRenderer, threeScene, threeCamera, arrowGroup, threeLoop = false;

function initThree() {
    if (threeRenderer) return;

    /* Renderer */
    threeRenderer = new THREE.WebGLRenderer({ alpha:true, antialias:true });
    threeRenderer.setSize(window.innerWidth, window.innerHeight);
    threeRenderer.setPixelRatio(window.devicePixelRatio);
    document.getElementById('three-container').appendChild(threeRenderer.domElement);

    /* Sc√®ne & cam√©ra ortho¬†‚Äì plus simple pour un overlay 2D */
    threeScene = new THREE.Scene();
    threeCamera = new THREE.OrthographicCamera(
        window.innerWidth/-2, window.innerWidth/2,
        window.innerHeight/2, window.innerHeight/-2,
        -1000, 1000
    );
    threeCamera.position.z = 10;

    /* G√©om√©trie fl√®che */
    const shaftGeo = new THREE.CylinderGeometry(8,8,180,16);
    const headGeo  = new THREE.ConeGeometry(25,80,20);
    const mat = new THREE.MeshPhongMaterial({ color:0xff3b3b });

    const shaft = new THREE.Mesh(shaftGeo, mat);
    const head  = new THREE.Mesh(headGeo, mat);
    shaft.position.y = 40;      // corps¬†‚Üë
    head.position.y  = 140;     // pointe
    head.rotateX(Math.PI);

    arrowGroup = new THREE.Group();
    arrowGroup.add(shaft); arrowGroup.add(head);
    arrowGroup.position.set(0,-60,0);
    threeScene.add(arrowGroup);

    /* Lumi√®re */
    threeScene.add(new THREE.DirectionalLight(0xffffff,0.9).position.set(0,0,1));
    threeScene.add(new THREE.AmbientLight(0xffffff,0.4));

    /* Loop */
    threeLoop = true;
    (function animate(){
        if(!threeLoop) return;
        threeRenderer.render(threeScene,threeCamera);
        requestAnimationFrame(animate);
    })();
}

/* Dispose pour lib√©rer la m√©moire */
function disposeThree() {
    if (!threeRenderer) return;
    threeLoop=false;
    threeRenderer.dispose();
    threeRenderer.domElement.remove();
    threeRenderer=threeScene=threeCamera=arrowGroup=null;
}

/* Resize */
window.addEventListener('resize',()=>{
    if(!threeRenderer) return;
    threeRenderer.setSize(window.innerWidth, window.innerHeight);
    threeCamera.left   = window.innerWidth/-2;
    threeCamera.right  = window.innerWidth/2;
    threeCamera.top    = window.innerHeight/2;
    threeCamera.bottom = window.innerHeight/-2;
    threeCamera.updateProjectionMatrix();
});

/* ---------- Pointer update ---------- */
function updateARPointer(){
    if(!selectedRestaurant || userHeading===null || !arrowGroup) return;
    const bearing = calculateBearing(userPosition, selectedRestaurant.position);
    const rel = (360 - userHeading + bearing) % 360;
    document.getElementById('ar-direction').textContent = rel.toFixed(0);
    arrowGroup.rotation.z = THREE.MathUtils.degToRad(rel);
}

/* ============================================================
   Basculer carte / AR
============================================================ */
async function toggleARMode(){
    const arView  = document.getElementById('ar-view');
    const mapCont = document.getElementById('map-container');
    const infoBox = document.getElementById('ar-info');
    const btn     = document.getElementById('ar-btn');

    if(arView.style.display==='block'){
        /* ---- Quitter AR ---- */
        arView.style.display='none';
        mapCont.style.display='block';
        infoBox.style.display='none';
        btn.textContent='üé•¬†Mode¬†AR';

        if(cameraStream){ cameraStream.getTracks().forEach(t=>t.stop()); cameraStream=null; }
        disposeThree();
    } else {
        /* ---- Entrer AR ---- */
        if(!selectedRestaurant){ alert("S√©lectionnez d'abord un restaurant"); return; }
        const ok = await startCamera(); if(!ok) return;

        arView.style.display='block';
        mapCont.style.display='none';
        infoBox.style.display='block';
        btn.textContent='üó∫Ô∏è¬†Retour¬†carte';

        initThree();
        setupOrientation();
        updateARPointer();
    }
}

/* ---------- √âv√©nements ---------- */
document.getElementById('locate-btn').addEventListener('click',locateUser);
document.getElementById('ar-btn').addEventListener('click',toggleARMode);

/* ---------- Init ---------- */
updateRestaurantList();
fixMapTiles();
window.addEventListener('resize',()=>{ map.invalidateSize(); fixMapTiles(); });
setTimeout(fixMapTiles,500);
</script>
</body>
</html>
